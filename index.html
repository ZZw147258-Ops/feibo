<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿é™©ä¸šåŠ¡å‘˜å®¢æˆ·æ¥é¾™ç³»ç»Ÿ</title>
    <style>
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            font-size: 16px;
            line-height: 1.5;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        .header h1 {
            font-size: 22px;
            margin-bottom: 8px;
            color: #1890ff;
        }
        .header p {
            font-size: 14px;
            color: #666;
        }
        .announcement {
            background: #fffbe6;
            border: 1px solid #ffe58f;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
        }
        .date-selector {
            margin: 15px 0;
        }
        .date-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        .date-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .date-btn {
            padding: 10px 5px;
            border: 2px solid #e8e8e8;
            border-radius: 6px;
            background: white;
            font-size: 12px;
            text-align: center;
            cursor: pointer;
        }
        .date-btn.active {
            border-color: #1890ff;
            background: #e6f7ff;
            color: #1890ff;
            font-weight: bold;
        }
        .session-selector {
            margin: 15px 0;
        }
        .session-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .session-btn {
            padding: 12px;
            border: 2px solid #e8e8e8;
            border-radius: 8px;
            background: white;
            text-align: center;
            cursor: pointer;
        }
        .session-btn.active {
            border-color: #1890ff;
            background: #e6f7ff;
            color: #1890ff;
            font-weight: bold;
        }
        .session-info {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        .remaining {
            color: #ff4d4f;
            font-weight: bold;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }
        input:focus, select:focus {
            border-color: #1890ff;
            outline: none;
        }
        .client-fields {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .client-field {
            margin-bottom: 10px;
        }
        .client-field:last-child {
            margin-bottom: 0;
        }
        button {
            width: 100%;
            padding: 15px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            margin-top: 20px;
            cursor: pointer;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background: #40a9ff;
        }
        .message {
            padding: 12px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            display: none;
        }
        .success { 
            background: #f6ffed; 
            border: 1px solid #b7eb8f; 
            color: #52c41a; 
        }
        .error { 
            background: #fff2f0; 
            border: 1px solid #ffccc7; 
            color: #ff4d4f; 
        }
        .info { 
            background: #e6f7ff; 
            border: 1px solid #91d5ff; 
            color: #1890ff; 
        }
        .my-records {
            margin-top: 20px;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
            display: none;
        }
        .record-item {
            padding: 10px;
            margin: 8px 0;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #1890ff;
        }
        .edit-btn {
            background: #52c41a;
            padding: 6px 12px;
            font-size: 12px;
            margin-top: 5px;
            width: auto;
        }
        .delete-btn {
            background: #ff4d4f;
            padding: 6px 12px;
            font-size: 12px;
            margin-top: 5px;
            width: auto;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¢ ä¿é™©ä¸šåŠ¡å‘˜å®¢æˆ·æ¥é¾™</h1>
            <p>è¯·é€‰æ‹©æ—¥æœŸå’Œåœºæ¬¡å¡«å†™å®¢æˆ·ä¿¡æ¯</p>
        </div>

        <!-- å…¬å‘Šæ  -->
        <div class="announcement">
            <strong>ğŸ“¢ å…¬å‘Šï¼š</strong>
            <span id="announcementText">æ¬¢è¿å‚åŠ å®¢æˆ·æ¥é¾™æ´»åŠ¨ï¼è¯·å…ˆé€‰æ‹©æ—¥æœŸå’Œåœºæ¬¡ã€‚</span>
        </div>

        <!-- æ—¥æœŸé€‰æ‹© -->
        <div class="date-selector">
            <label>ğŸ“… é€‰æ‹©æ—¥æœŸï¼š</label>
            <div class="date-buttons" id="dateButtons">
                <!-- æ—¥æœŸæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- åœºæ¬¡é€‰æ‹© -->
        <div class="session-selector">
            <label>â° é€‰æ‹©åœºæ¬¡ï¼š</label>
            <div class="session-buttons">
                <div class="session-btn" data-session="am" onclick="selectSession('am')">
                    ä¸Šåˆåœº<br>
                    <span class="session-info">10:00-12:00</span>
                    <div class="session-info">å‰©ä½™ï¼š<span id="amRemaining">20</span>/20äºº</div>
                </div>
                <div class="session-btn" data-session="pm" onclick="selectSession('pm')">
                    ä¸‹åˆåœº<br>
                    <span class="session-info">14:00-17:00</span>
                    <div class="session-info">å‰©ä½™ï¼š<span id="pmRemaining">20</span>/20äºº</div>
                </div>
            </div>
        </div>

        <!-- æŠ¥åè¡¨å• -->
        <form id="signupForm">
            <div class="form-group">
                <label for="agentName">ğŸ‘¤ ä¸šåŠ¡å‘˜å§“åï¼š</label>
                <input type="text" id="agentName" placeholder="è¯·è¾“å…¥æ‚¨çš„çœŸå®å§“å" required>
            </div>

            <div class="form-group">
                <label for="agentPhone">ğŸ“ ä¸šåŠ¡å‘˜æ‰‹æœºå·ï¼š</label>
                <input type="tel" id="agentPhone" placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·" required>
            </div>

            <div class="form-group">
                <label>ğŸ‘¥ æºå¸¦å®¢æˆ·ï¼š</label>
                <select id="guestCount" required onchange="toggleClientFields()">
                    <option value="">è¯·é€‰æ‹©å®¢æˆ·äººæ•°</option>
                    <option value="1">1ä½å®¢æˆ·</option>
                    <option value="2">2ä½å®¢æˆ·</option>
                </select>
            </div>

            <!-- å®¢æˆ·å§“åè¾“å…¥åŒºåŸŸ -->
            <div class="client-fields" id="clientFields" style="display: none;">
                <div class="client-field" id="client1Field">
                    <label>å®¢æˆ·1å§“åï¼š</label>
                    <input type="text" id="client1" placeholder="è¯·è¾“å…¥å®¢æˆ·å§“å">
                </div>
                <div class="client-field" id="client2Field" style="display: none;">
                    <label>å®¢æˆ·2å§“åï¼š</label>
                    <input type="text" id="client2" placeholder="è¯·è¾“å…¥å®¢æˆ·å§“å">
                </div>
            </div>

            <button type="submit" id="submitBtn">æäº¤æŠ¥å</button>
        </form>

        <!-- æˆ‘çš„æŠ¥åè®°å½• -->
        <div class="my-records" id="myRecords">
            <h3>ğŸ“‹ æˆ‘çš„æŠ¥åè®°å½•</h3>
            <div id="recordsList"></div>
        </div>

        <!-- æ¶ˆæ¯æ˜¾ç¤º -->
        <div id="message" class="message"></div>
    </div>

    <script>
        // åˆå§‹åŒ–æ—¥æœŸèŒƒå›´ï¼š11æœˆ25-30æ—¥
        const dateRange = [
            '2024-11-25', '2024-11-26', '2024-11-27', 
            '2024-11-28', '2024-11-29', '2024-11-30'
        ];

        let selectedDate = '';
        let selectedSession = '';

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            initDates();
            loadAnnouncement();
            checkMyRecords();
        });

        // åˆå§‹åŒ–æ—¥æœŸæŒ‰é’®
        function initDates() {
            const dateButtons = document.getElementById('dateButtons');
            const today = new Date().toISOString().split('T')[0];
            
            dateRange.forEach(date => {
                const dateObj = new Date(date);
                const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const month = dateObj.getMonth() + 1;
                const day = dateObj.getDate();
                const weekDay = weekDays[dateObj.getDay()];
                
                const button = document.createElement('div');
                button.className = 'date-btn';
                button.textContent = `${month}.${day}å‘¨${weekDay}`;
                button.setAttribute('data-date', date);
                
                button.onclick = function() {
                    selectDate(date);
                };
                
                // é»˜è®¤é€‰æ‹©ä»Šå¤©æˆ–ç¬¬ä¸€ä¸ªå¯ç”¨æ—¥æœŸ
                if (date === today || (!selectedDate && date === dateRange[0])) {
                    selectDate(date);
                }
                
                dateButtons.appendChild(button);
            });
        }

        // é€‰æ‹©æ—¥æœŸ
        function selectDate(date) {
            selectedDate = date;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-date') === date) {
                    btn.classList.add('active');
                }
            });
            
            // æ›´æ–°åœºæ¬¡åé¢æ˜¾ç¤º
            updateSessionRemaining();
            checkMyRecords();
        }

        // é€‰æ‹©åœºæ¬¡
        function selectSession(session) {
            selectedSession = session;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.session-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-session') === session) {
                    btn.classList.add('active');
                }
            });
            
            checkMyRecords();
        }

        // åˆ‡æ¢å®¢æˆ·å§“åå­—æ®µæ˜¾ç¤º
        function toggleClientFields() {
            const guestCount = parseInt(document.getElementById('guestCount').value);
            const clientFields = document.getElementById('clientFields');
            const client1Field = document.getElementById('client1Field');
            const client2Field = document.getElementById('client2Field');
            
            if (guestCount > 0) {
                clientFields.style.display = 'block';
                client1Field.style.display = 'block';
                client2Field.style.display = guestCount >= 2 ? 'block' : 'none';
            } else {
                clientFields.style.display = 'none';
            }
        }

        // æ›´æ–°åœºæ¬¡å‰©ä½™åé¢
        function updateSessionRemaining() {
            if (!selectedDate) return;
            
            const amRemaining = document.getElementById('amRemaining');
            const pmRemaining = document.getElementById('pmRemaining');
            
            const amData = getSessionData(selectedDate, 'am');
            const pmData = getSessionData(selectedDate, 'pm');
            
            const amTotal = amData.reduce((sum, item) => sum + parseInt(item.guestCount), 0);
            const pmTotal = pmData.reduce((sum, item) => sum + parseInt(item.guestCount), 0);
            
            amRemaining.textContent = 20 - amTotal;
            pmRemaining.textContent = 20 - pmTotal;
        }

        // è·å–åœºæ¬¡æ•°æ®
        function getSessionData(date, session) {
            const allData = getAllData();
            return allData.filter(item => 
                item.date === date && item.session === session
            );
        }

        // è·å–æ‰€æœ‰æ•°æ®
        function getAllData() {
            const data = localStorage.getItem('insurance_signup_data');
            return data ? JSON.parse(data) : [];
        }

        // ä¿å­˜æ•°æ®
        function saveData(data) {
            localStorage.setItem('insurance_signup_data', JSON.stringify(data));
        }

        // åŠ è½½å…¬å‘Š
        function loadAnnouncement() {
            const announcement = localStorage.getItem('insurance_announcement');
            if (announcement) {
                document.getElementById('announcementText').textContent = announcement;
            }
        }

        // æ£€æŸ¥æˆ‘çš„æŠ¥åè®°å½•
        function checkMyRecords() {
            const agentPhone = document.getElementById('agentPhone').value;
            const myRecords = document.getElementById('myRecords');
            const recordsList = document.getElementById('recordsList');
            
            if (!agentPhone || !selectedDate) {
                myRecords.style.display = 'none';
                return;
            }
            
            const allData = getAllData();
            const myData = allData.filter(item => 
                item.agentPhone === agentPhone && item.date === selectedDate
            );
            
            if (myData.length === 0) {
                myRecords.style.display = 'none';
                return;
            }
            
            recordsList.innerHTML = myData.map(item => `
                <div class="record-item">
                    <strong>${item.session === 'am' ? 'ä¸Šåˆåœº' : 'ä¸‹åˆåœº'}</strong><br>
                    å®¢æˆ·äººæ•°ï¼š${item.guestCount}äºº<br>
                    ${item.guestCount >= 1 ? `å®¢æˆ·1ï¼š${item.client1 || 'æœªå¡«å†™'}` : ''}<br>
                    ${item.guestCount >= 2 ? `å®¢æˆ·2ï¼š${item.client2 || 'æœªå¡«å†™'}` : ''}<br>
                    <button class="edit-btn" onclick="editRecord('${item.id}')">ä¿®æ”¹å®¢æˆ·å§“å</button>
                    <button class="delete-btn" onclick="deleteRecord('${item.id}')">åˆ é™¤</button>
                </div>
            `).join('');
            
            myRecords.style.display = 'block';
        }

        // è¡¨å•æäº¤
        document.getElementById('signupForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }
            
            const formData = {
                id: generateId(),
                date: selectedDate,
                session: selectedSession,
                agentName: document.getElementById('agentName').value.trim(),
                agentPhone: document.getElementById('agentPhone').value.trim(),
                guestCount: document.getElementById('guestCount').value,
                client1: document.getElementById('client1').value.trim(),
                client2: document.getElementById('client2').value.trim(),
                timestamp: new Date().toISOString()
            };
            
            // æ£€æŸ¥ä¸šåŠ¡å‘˜åœ¨è¯¥åœºæ¬¡æ˜¯å¦å·²è¶…é™
            if (!checkAgentLimit(formData)) {
                return;
            }
            
            // ä¿å­˜æ•°æ®
            const allData = getAllData();
            allData.push(formData);
            saveData(allData);
            
            showMessage('æŠ¥åæˆåŠŸï¼', 'success');
            updateSessionRemaining();
            checkMyRecords();
            resetForm();
        });

        // éªŒè¯è¡¨å•
        function validateForm() {
            if (!selectedDate) {
                showMessage('è¯·é€‰æ‹©æ—¥æœŸï¼', 'error');
                return false;
            }
            
            if (!selectedSession) {
                showMessage('è¯·é€‰æ‹©åœºæ¬¡ï¼', 'error');
                return false;
            }
            
            const agentName = document.getElementById('agentName').value.trim();
            const agentPhone = document.getElementById('agentPhone').value.trim();
            const guestCount = document.getElementById('guestCount').value;
            
            if (!agentName) {
                showMessage('è¯·è¾“å…¥ä¸šåŠ¡å‘˜å§“åï¼', 'error');
                return false;
            }
            
            if (!agentPhone || !/^1[3-9]\d{9}$/.test(agentPhone)) {
                showMessage('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ï¼', 'error');
                return false;
            }
            
            if (!guestCount) {
                showMessage('è¯·é€‰æ‹©æºå¸¦å®¢æˆ·äººæ•°ï¼', 'error');
                return false;
            }
            
            // éªŒè¯å®¢æˆ·å§“å
            const client1 = document.getElementById('client1').value.trim();
            const client2 = document.getElementById('client2').value.trim();
            
            if (guestCount >= 1 && !client1) {
                showMessage('è¯·è¾“å…¥å®¢æˆ·1å§“åï¼', 'error');
                return false;
            }
            
            if (guestCount >= 2 && !client2) {
                showMessage('è¯·è¾“å…¥å®¢æˆ·2å§“åï¼', 'error');
                return false;
            }
            
            return true;
        }

        // æ£€æŸ¥ä¸šåŠ¡å‘˜é™åˆ¶
        function checkAgentLimit(formData) {
            const allData = getAllData();
            const agentSessionData = allData.filter(item => 
                item.date === formData.date && 
                item.session === formData.session && 
                item.agentPhone === formData.agentPhone
            );
            
            const totalGuests = agentSessionData.reduce((sum, item) => sum + parseInt(item.guestCount), 0);
            const newTotal = totalGuests + parseInt(formData.guestCount);
            
            if (newTotal > 2) {
                showMessage(`æ‚¨åœ¨æœ¬åœºæ¬¡å·²æŠ¥${totalGuests}äººï¼Œæœ¬æ¬¡æŠ¥${formData.guestCount}äººå°†è¶…è¿‡2äººé™åˆ¶ï¼`, 'error');
                return false;
            }
            
            // æ£€æŸ¥åœºæ¬¡æ€»äººæ•°é™åˆ¶
            const sessionData = allData.filter(item => 
                item.date === formData.date && 
                item.session === formData.session
            );
            
            const sessionTotal = sessionData.reduce((sum, item) => sum + parseInt(item.guestCount), 0);
            const newSessionTotal = sessionTotal + parseInt(formData.guestCount);
            
            if (newSessionTotal > 20) {
                showMessage('è¯¥åœºæ¬¡åé¢å·²æ»¡ï¼', 'error');
                return false;
            }
            
            return true;
        }

        // ç”Ÿæˆå”¯ä¸€ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            document.getElementById('agentName').value = '';
            document.getElementById('guestCount').value = '';
            document.getElementById('client1').value = '';
            document.getElementById('client2').value = '';
            document.getElementById('clientFields').style.display = 'none';
        }

        // ç¼–è¾‘è®°å½•
        function editRecord(recordId) {
            const allData = getAllData();
            const record = allData.find(item => item.id === recordId);
            
            if (!record) {
                showMessage('è®°å½•ä¸å­˜åœ¨ï¼', 'error');
                return;
            }
            
            const newClient1 = prompt('è¯·è¾“å…¥å®¢æˆ·1å§“åï¼š', record.client1 || '');
            if (newClient1 === null) return;
            
            const newClient2 = record.guestCount >= 2 ? 
                prompt('è¯·è¾“å…¥å®¢æˆ·2å§“åï¼š', record.client2 || '') : '';
            
            if (newClient2 === null) return;
            
            record.client1 = newClient1.trim();
            if (record.guestCount >= 2) {
                record.client2 = newClient2.trim();
            }
            
            saveData(allData);
            showMessage('å®¢æˆ·å§“åä¿®æ”¹æˆåŠŸï¼', 'success');
            checkMyRecords();
        }

        // åˆ é™¤è®°å½•
        function deleteRecord(recordId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                return;
            }
            
            const allData = getAllData();
            const filteredData = allData.filter(item => item.id !== recordId);
            saveData(filteredData);
            
            showMessage('è®°å½•åˆ é™¤æˆåŠŸï¼', 'success');
            updateSessionRemaining();
            checkMyRecords();
        }

        // æ‰‹æœºå·è¾“å…¥æ—¶æ£€æŸ¥è®°å½•
        document.getElementById('agentPhone').addEventListener('input', function() {
            setTimeout(() => {
                checkMyRecords();
            }, 500);
        });
    </script>
</body>
</html>